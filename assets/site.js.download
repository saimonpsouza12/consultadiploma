var CONFIGS = {
    initialize: function () {
        this.fadeOutBoxSumary();
        this.switch();
        this.format();
        this.masks();
    },
    fadeOutBoxSumary: function () {
        setTimeout(function () {
            $(".box-summary").fadeOut(1500);
        }, 1000);
    },
    switch: function () {
        $('[data-switch=true]').bootstrapSwitch({ onText: 'Sim', offText: 'Não' });
    },
    format: function () {
        if (!String.prototype.format) {
            String.prototype.format = function () {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function (match, number) {
                    return typeof args[number] != 'undefined' ? args[number] : match;
                });
            };
        };
    },
    masks: function () {
        $(".cnpjMask").inputmask({ mask: "99.999.999/9999-99" });
        $(".cpfMask").inputmask({ mask: "999.999.999-99" });
        $("#PhoneNumber").inputmask({ mask: "(99) 99999-9999" });
        $(".moneyMask").maskMoney({ decimal: ",", thousands: ".", affixesStay: false });
        $(".moneyMaskPrefix").maskMoney({ prefix: "R$ ", decimal: ",", thousands: ".", affixesStay: false });
        $(".txtCalendario").inputmask({ mask: "99/99/9999" });
        $(".txtCalendario").datetimepicker({
            minView: 2,
            autoclose: true,
            useCurrent: false,
            inline: false,
            format: 'dd/mm/yyyy',
            language: 'pt-BR',
            sideBySide: true,
            widgetPositioning:
            {
                horizontal: 'left',
                vertical: 'bottom'
            }
        });
        $(".cepMask").inputmask({ mask: "99999-999" });
    }
};
CONFIGS.initialize();

function AJAXMODAL() {
    $.ajaxSetup({ cache: false });
    initialize();
    function initialize() {
        $("a[data-modal]").on("click",
            function (e) {
                $('#myModalContent').load(this.href,
                    function () {
                        $('#myModal').modal({ backdrop: 'static', keyboard: false }, 'show');
                        bindForm(this);
                    });
                return false;
            });
    };
    function reload(result) {
        AJAX.get({ url: result.data.url })
            .done(function (html) {

                $('#myModal').modal('hide');

                let idTarget = result.data.target;
                if (!idTarget)
                    idTarget = "Target";

                $(`#${idTarget}`).html(html);
                initialize();

                let seletor = result.data.seletor;
                if (seletor) {
                    seletor = '#' + seletor;
                    DATATABLE.initialize({ seletor: seletor });
                }
                else {
                    DATATABLE.initialize();
                }

                AVISO.swallRESULT(result);
                CONFIGS.switch();
            });
    };
    function bindForm(dialog) {
        $('form', dialog).submit(function () {

            AJAX.post({ url: this.action, parametros: $(this).serialize() })
                .done(function (result) {
                    if ((result.success == true || result.success == false) && result != undefined) {
                        reload(result);
                    }
                    else {
                        $('#myModalContent').html(result);
                        bindForm(dialog);
                    }
                });
            return false;
        });
    };
};

var AJAX = {
    get: function (options) {
        return $.ajax({
            type: "GET",
            url: options.url,
            beforeSend: function () {
                LOADING.bloquear('Processando...');
            },
            complete: function () {
                LOADING.desbloquear();
            },
            data: options.parametros,
            contentType: options.contentType,
            dataType: options.dataType
        });
    },
    post: function (options) {
        return $.ajax({
            type: "POST",
            url: options.url,
            beforeSend: function () {
                LOADING.bloquear('Processando...');
            },
            complete: function () {
                LOADING.desbloquear();
            },
            data: options.parametros,
            contentType: options.contentType,
            dataType: options.dataType
        });
    }
};

var BUSCACEP = {
    limpar: function () {
        $(".logradouro").val("");
        $(".bairro").val("");
        $(".cidade").val("");
        $(".estado").val("");
    },
    initialize: function () {
        $(".btnBuscaCep").click(function () {

            var cep = $(".cep").val().replace(/\D/g, '');
            if (cep != "") {

                var validacep = /^[0-9]{8}$/;
                if (validacep.test(cep)) {

                    $(".logradouro").val("...");
                    $(".bairro").val("...");
                    $(".cidade").val("...");
                    $(".estado").val("...");

                    LOADING.bloquear();

                    $.ajax({
                        url: `/CEP/ObterCEP`,
                        type: 'GET',
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: { numero: cep },
                        success: function (result) {
                            if (result.success) {
                                let cep = result.data;

                                if (cep) {
                                    $(".logradouro").val(cep.logradouro);
                                    $(".bairro").val(cep.bairro.nome);
                                    $(".cidade").val(cep.bairro.cidade.nome);
                                    $(".estado").val(cep.bairro.cidade.estado.sigla);
                                }
                                else {
                                    BUSCACEP.limpar();
                                    AVISO.swallERROR("CEP não encontrado!");
                                }
                            }
                            else {
                                BUSCACEP.limpar();
                                AVISO.swallERROR(result.message);
                            }

                            LOADING.desbloquear();
                        }
                    });

                }
                else {
                    BUSCACEP.limpar();
                    AVISO.swallERROR("Formato de CEP inválido!");
                }
            }
            else {
                BUSCACEP.limpar();
                AVISO.swallERROR("Informe o CEP!");
            }
        });
    }
};

var LOADIMAGE = {
    initialize: function (seletor) {
        document.getElementById(seletor).onchange = function (evt) {
            document.getElementById("img_nome").innerHTML = this.files[0].name;
            document.getElementById("img_nome").style.display = "block";

            var tgt = evt.target || window.event.srcElement,
                files = tgt.files;

            if (FileReader && files && files.length) {
                var fr = new FileReader();
                fr.onload = (fn) => document.getElementById("container_img").src = fr.result;
                fr.readAsDataURL(files[0]);
            };
        };
    }
};

var AVISO = {
    swallCONFIRM: function (title = 'Sim, exclua-o!') {
        return Swal.fire({
            title: 'Você tem certeza?',
            text: "Você não poderá reverter isso!",
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#5d78ff',
            cancelButtonColor: '#fd397a',
            confirmButtonText: title
        });
    },
    swallRESULT: function (result) {
        var type = result.success ? 'success' : 'error';
        var timer = result.success ? 3000 : 9000;

        this.notify(result.message, type, timer);
    },
    swallSUCCESS: function (message) {
        this.notify(message, 'success', 3000);
    },
    swallERROR: function (message) {
        this.notify(message, 'error', 9000);
    },
    swallCENTERED: function (message) {
        this.notifyCenter(message, 'info', 9000);
    },
    notify: function (msg, type, timer) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: timer
        });
        Toast.fire({ type: type, title: msg });
    },
    notifyCenter: function (msg, type) {

        const Toast = Swal.mixin({
            toast: true,
            position: 'center',
            showConfirmButton: false
        });

        Toast.fire({
            type: type,
            title: msg
        });
    },
    showSwallERROR: function (message) {
        return swal.fire("Ops!", message, "error");
    }

};

var LOADING = {
    bloquear: function () {
        var html2 = '<div class="lds-css text-center"><div style="width:50%;height:50%" class="lds-flickr"><div></div><div></div><div></div></div></div>';
        $.blockUI({
            target: $('body'),
            message: html2,
            baseZ: 1000,
            css: {
                border: '0',
                padding: '0',
                backgroundColor: '#000'
            },
            overlayCSS: {
                backgroundColor: '#000',
                opacity: 0.5,
                cursor: 'wait'
            }
        });
    },
    desbloquear: function () {
        $.unblockUI();
    }
};

var IMPRESSAO = {
    liberarImpressao: function (elemento, status) {
        $("." + elemento).css({ "display": status });
    },
    printPDF: function (content, filename) {
        //add file partial view _Kendo
        this.liberarImpressao("pdf-no-print", "none");

        var elemento = $("#" + content);
        kendo.drawing.drawDOM(elemento, {
            paperSize: "auto",
            multiPage: true,
            landscape: true,
            margin: { left: "1cm", top: "1cm", right: "1cm", bottom: "1cm" },
            scale: 0.8
        })
            .then(function (group) {
                return kendo.drawing.exportPDF(group);
            })
            .done(function (data) {
                kendo.saveAs({
                    dataURI: data,
                    fileName: filename + ".pdf"
                });
                this.liberarImpressao("pdf-no-print", "");
            });
    },
    f: function (e, f) {
        return e.replace(/{(\w+)}/g, function (e, m) {
            return f[m]
        })
    },
    printExcel: function (e, g) {
        e.nodeType || (e = document.getElementById(e));

        this.liberarImpressao("pdf-no-print", "none");

        //clona a div básica
        var $clonedElement = $("#" + e.id).clone();
        //remove os elementos com display none
        $clonedElement.find('[style*="display: none"]').remove();

        var l = window.location, m;
        m = this.f('<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><\!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\>  <meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8"><meta name=ProgId content=Excel.Sheet><meta name=Generator content="Microsoft Excel 11"></head><body><table>{table}</table></body></html>', {
            worksheet: g || "Worksheet", table: $clonedElement[0].innerHTML
        });

        var blob = new Blob([m], { type: "application/vnd.ms-excel;" });
        saveAs(blob, g + ".xls");

        this.liberarImpressao("pdf-no-print", "");
    }
};

var PARTIAL = {
    obterPartialView: function (elementoAlvo, urlAlvo, data) {

        var targetAlvo = "#" + elementoAlvo;

        $.ajax({
            url: urlAlvo,
            method: "GET",
            contentType: "application/json",
            dataType: "html",
            data: data,
            beforeSend: function () {
                LOADING.bloquear();
            },
            success: function (result) {
                $(targetAlvo).html(result);
                DATATABLE.initialize();
            }
        }).done(function () {
            LOADING.desbloquear();
        });
    }
};


var DATATABLE = {
    destroy: function (seletor) {
        if ($.fn.DataTable.isDataTable(seletor)) {
            $(seletor).DataTable().destroy();
        };
    },
    initializeAjax: function (options) {

        if (!options) options = {};
        options.seletor = options.seletor === undefined ? '.tabelaDinamicaV2' : options.seletor;
        options.pagingType = options.pagingType === undefined ? "simple_numbers" : options.pagingType;
        options.responsive = options.responsive === undefined ? false : options.responsive;
        options.processing = options.processing === undefined ? false : options.processing;
        options.serverSide = options.serverSide === undefined ? true : options.serverSide;
        options.searching = options.searching === undefined ? true : options.searching;
        options.stateSave = options.stateSave === undefined ? false : options.stateSave;
        options.ordering = options.ordering === undefined ? false : options.ordering;
        options.paging = options.paging === undefined ? true : options.paging;
        options.size = options.size === undefined ? 10 : options.size;
        options.info = options.info === undefined ? true : options.info;

        this.destroy(options.seletor);

        grid = $(options.seletor).dataTable({
            bSort: !1, language: {
                sEmptyTable: "Nenhum registro encontrado", sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros", sInfoEmpty: "Mostrando 0 até 0 de 0 registros", sInfoFiltered: "(Filtrados de _MAX_ registros)", sInfoPostFix: "", sInfoThousands: ".", sLengthMenu: "_MENU_ resultados por página", sLoadingRecords: "Carregando...", sProcessing: "Processando...", sZeroRecords: "Nenhum registro encontrado", sSearch: "Pesquisar", oPaginate: {
                    sNext: "Próximo", sPrevious: "Anterior", sFirst: "Primeiro", sLast: "Último"
                },
                oAria: {
                    sSortAscending: ": Ordenar colunas de forma ascendente", sSortDescending: ": Ordenar colunas de forma descendente"
                }
            },
            lengthMenu: [[10, 20, 40, 60, 80, 100, -1], [10, 20, 40, 60, 80, 100, "Todos"]],
            pagingType: options.pagingType,
            responsive: options.responsive,
            processing: options.processing,
            serverSide: options.serverSide,
            searching: options.searching,
            stateSave: options.stateSave,
            ordering: options.ordering,
            paging: options.paging,
            pageLength: options.size,
            info: options.info,
            ajax: {
                method: "POST",
                url: options.url,
                beforeSend: function () {
                    LOADING.bloquear();
                },
                complete: function () {
                    LOADING.desbloquear();

                    if ((options.loadboostrap_select === undefined ? true : options.loadboostrap_select)) {
                        CONFIGS.switch();
                    };
                }
            },
            columns: options.columns
        });

        $(".dataTables_filter input")
            .unbind() // Desvincular ligações padrão anteriores
            .bind("input", function (e) { // Vincule nosso comportamento desejado
                // Se o comprimento tiver 3 ou mais caracteres ou o usuário pressionar ENTER, pesquise
                if (this.value.length >= 3 || e.keyCode == 13) {
                    // Chame a função de pesquisa da API
                    grid.api().search(this.value).draw();
                }
                // Certifique-se de limpar a pesquisa se eles retrocederem o suficiente
                if (this.value == "") {
                    grid.api().search("").draw();
                }
                return;
            });
    },
    initialize: function (options) {

        if (!options) options = {};
        options.seletor = options.seletor === undefined ? '.tabelaDinamicaV2' : options.seletor;
        options.pagingType = options.pagingType === undefined ? "simple_numbers" : options.pagingType;
        options.responsive = options.responsive === undefined ? false : options.responsive;
        options.processing = options.processing === undefined ? false : options.processing;
        options.serverSide = options.serverSide === undefined ? false : options.serverSide;
        options.searching = options.searching === undefined ? true : options.searching;
        options.stateSave = options.stateSave === undefined ? false : options.stateSave;
        options.ordering = options.ordering === undefined ? false : options.ordering;
        options.paging = options.paging === undefined ? true : options.paging;
        options.size = options.size === undefined ? 10 : options.size;
        options.info = options.info === undefined ? true : options.info;

        this.destroy(options.seletor);

        grid = $(options.seletor).dataTable({
            bSort: !1, language: {
                sEmptyTable: "Nenhum registro encontrado", sInfo: "Mostrando de _START_ até _END_ de _TOTAL_ registros", sInfoEmpty: "Mostrando 0 até 0 de 0 registros", sInfoFiltered: "(Filtrados de _MAX_ registros)", sInfoPostFix: "", sInfoThousands: ".", sLengthMenu: "_MENU_ resultados por página", sLoadingRecords: "Carregando...", sProcessing: "Processando...", sZeroRecords: "Nenhum registro encontrado", sSearch: "Pesquisar", oPaginate: {
                    sNext: "Próximo", sPrevious: "Anterior", sFirst: "Primeiro", sLast: "Último"
                }
                ,
                oAria: {
                    sSortAscending: ": Ordenar colunas de forma ascendente", sSortDescending: ": Ordenar colunas de forma descendente"
                }
            },
            lengthMenu: [[10, 20, 40, 60, 80, 100, -1], [10, 20, 40, 60, 80, 100, "Todos"]],
            pagingType: options.pagingType,
            responsive: options.responsive,
            processing: options.processing,
            serverSide: options.serverSide,
            searching: options.searching,
            stateSave: options.stateSave,
            ordering: options.ordering,
            paging: options.paging,
            pageLength: options.size,
            info: options.info
        });
    }
};

var BOOTSTRAPSELECT = {
    initialize: function () {
        $('.selectSearch').attr('data-live-search', true);
        $('.selectSearch').selectpicker('refresh');
        $('.selectSearch').selectpicker();
    }
};

var UTILS = {
    alterarExclusao: function (checkbox, controller, action, id, excluido) {
        $.ajax({
            url: `/${controller}/${action}`,
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: { id: id, excluido: excluido },
            success: function (result) {
                if (!result.success)
                    checkbox.checked = !checkbox.checked;
                AVISO.swallRESULT(result);
            }
        });
    },
    getUrlParams: function (url) {
        let params = [];
        if (url) {
            let indice = url.indexOf("?");
            if (indice >= 0) {
                indice++;
                let strParametros = url.substring(indice);
                var arrayParametros = strParametros.split('&');

                arrayParametros.forEach(p => {
                    let arrayParametro = p.split('=');
                    params.push({ chave: arrayParametro[0], valor: arrayParametro[1] });
                });

            }
        }
        console.log(params);
        return params;
    },
    getValorUrlParam: function (url, chave) {
        let valor = null;
        let params = UTILS.getUrlParams(url);
        let parametros = params.filter(p => p.chave.toLowerCase() == chave.toLowerCase());
        if (parametros && parametros.length > 0)
            valor = parametros[0].valor;

        return valor;
    },
    isObjetoValido: function (obj) {
        return obj !== null && obj !== undefined && obj !== '';
    }
};

var myDropzone;
var DROPZONE =
{
    inicializeAutomatic: function (options) {
        // set the dropzone container id
        var id = options.seletor === undefined ? '#kt_dropzone_5' : options.seletor;
        var url = options.url === undefined ? '' : options.url;
        var parallelUploads = options.parallelUploads === undefined ? 1 : options.parallelUploads;
        var maxFilesize = options.maxFilesize === undefined ? 1 : options.maxFilesize;
        var acceptedFiles = options.acceptedFiles === undefined ? 'image/*,application/pdf' : options.acceptedFiles;
        var map = options.map === undefined ? new Map() : options.map;
        var autoProcessQueue = options.autoProcessQueue === undefined ? true : options.autoProcessQueue;
        var maxFiles = options.maxFiles === undefined ? 1 : options.maxFiles;
        var useTemplate = options.useTemplate === undefined ? true : options.useTemplate;
        var callbackOnComplete = options.callbackOnComplete;

        if (useTemplate) {

            // set the preview element template
            var previewNode = $(id + " .dropzone-item");
            previewNode.id = "";
            var previewTemplate = previewNode.parent('.dropzone-items').html();
            previewNode.remove();

            myDropzone = new Dropzone(id, { // Make the whole body a dropzone
                url: url, // Set the url for your upload script location
                parallelUploads: parallelUploads,
                autoProcessQueue: autoProcessQueue,
                maxFiles: maxFiles,
                maxFilesize: maxFilesize, // Max filesize in MB
                previewTemplate: previewTemplate,
                previewsContainer: id + " .dropzone-items", // Define the container to display the previews
                clickable: id + " .dropzone-select", // Define the element that should be used as click trigger to select files.,
                acceptedFiles: acceptedFiles
            });
        }
        else {
            myDropzone = new Dropzone(id, { // Make the whole body a dropzone
                url: url, // Set the url for your upload script location
                autoProcessQueue: autoProcessQueue,
                parallelUploads: 5,
                maxFiles: maxFiles,
                maxFilesize: maxFilesize, // Max filesize in MB
                acceptedFiles: acceptedFiles,
                addRemoveLinks: true,
                paramName: "file",
                uploadMultiple: true,
                accept: function (file, done) {
                    done();
                }
            });
        }

        myDropzone.on("addedfile", function (file) {
            // Hookup the start button
            var control = $(document).find(id + ' .dropzone-item');
            if (control.length <= 0) return;
            $(document).find(id + ' .dropzone-item').css('display', '');
        });

        // Update the total progress bar
        myDropzone.on("totaluploadprogress", function (progress) {
            var control = $(id + " .progress-bar");
            if (control.length <= 0) return;
            control.css('width', progress + "%");
        });

        myDropzone.on("sending", function (file, xhr, formData) {
            // Show the total progress bar when upload starts
            $(id + " .progress-bar").css('opacity', "1");
            for (let [key, value] of map) {
                formData.append(key, value);
            }
            //for (var name in hash) {
            //    formData.append("fonteDadosId", "EC324114-F00D-4C8B-9262-D19068F4C96D");
            //}
        });

        // Hide the total progress bar when nothing's uploading anymore
        myDropzone.on("complete", function (progress) {
            var thisProgressBar = id + " .dz-complete";
            setTimeout(function () {
                $(thisProgressBar + " .progress-bar, " + thisProgressBar + " .progress").css('opacity', '0');
                if (callbackOnComplete != undefined)
                    callbackOnComplete();
            }, 300)
        });
    }
};


var SUMMERNOTE = {
    initialize: function (seletor, height) {
        if (!seletor)
            seletor = ".summernote";

        if (!height)
            height = 150;

        $(seletor).summernote({
            height: height
        });
    }
};