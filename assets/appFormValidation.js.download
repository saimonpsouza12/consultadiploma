"use strict";

// Class definition
var FormValidation = function () {

    // Base elements
    var formEl;
    var validator;
    var resultForm;
    var rules = {
        //= Step 1
        titulo: {
            required: true
        },
        descricao: {
            required: true,
        }
    };
    var messages = {};

    // Private functions
    var initValidation = function (options) {

        if (options.rules)
            rules = options.rules;

        if (options.messages)
            messages = options.messages;

        validator = formEl.validate({
            // Validate only visible fields
            ignore: ":hidden",

            // Validation rules
            rules: rules,

            // Display error
            invalidHandler: function (event, validator) {
                KTUtil.scrollTop();

                swal.fire({
                    "title": "",
                    "text": "Existem alguns erros no seu envio. Corrija-os.",
                    "type": "error",
                    "confirmButtonClass": "btn btn-secondary"
                });
            },

            submitHandler: function (form) {

            }
        });
    };
    var initSubmit = function (options) {
        var btn = $('.btnToolbarSave');

        btn.on('click', function (e) {
            e.preventDefault();

            var action = $(this).attr("data-action-flag");
            var ajaxSubmit = $(this).attr("data-form-ajaxsubmit");


            if (action === "remove") {
                var controller = $(this).attr("data-action-controller");
                var id = $(this).attr("data-action-id");
                AVISO.swallCONFIRM()
                    .then((result) => {
                        if (result.value) {

                            $.post(`/${controller}/deletar`, { id: id }, function (result) {
                                AVISO.swallRESULT(result);
                                setTimeout(function () {
                                    window.location.href = result.data.page;
                                }, 1000);
                            });
                        }
                    });

                return;
            };

            var validate = validator.form();
            if (ajaxSubmit == "false")
            {
                if (validate)
                    executeSubmitForm();

                return;
            }
            if (validate) {
                KTApp.progress(btn);
                KTApp.block(formEl);

                var actionPostToolbar = $("#buttonAction");

                if (actionPostToolbar === undefined || actionPostToolbar === null || actionPostToolbar.length === 0) {
                    $('<input>').attr({
                        type: 'hidden',
                        id: 'buttonAction',
                        name: 'buttonAction',
                        value: action
                    }).appendTo('form');
                }
                else {
                    actionPostToolbar.val(action);
                }

                formEl.ajaxSubmit({

                    error: function (result) {
                        AVISO.swallRESULT(result);
                    },

                    success: function (result) {
                        KTApp.unprogress(btn);
                        KTApp.unblock(formEl);

                        if (!result.success) {
                            AVISO.swallRESULT(result);
                            return;
                        }

                        resultForm = result;

                        if (options.redirect) {
                            window.location.href = resultForm.data.page;
                        }
                        else {
                            AVISO.swallRESULT(result);
                            setTimeout(function () {
                                window.location.href = resultForm.data.page;
                            }, 1000);
                        }
                    }
                });
            }
        });
    };

    return {
        init: function (options) {
            if (!options) options = {};
            options.seletor = options.seletor === undefined ? '#kt_form' : options.seletor;
            formEl = $(options.seletor);

            initValidation(options);
            initSubmit(options);
        },
        validate: function () {
            let validate = validator.form();
            return validate;
        }
    };
}();